<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Завършване на поръчка - Климатици ЕООД</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        /* Header */
        .header {
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #0891b2;
            font-size: 24px;
            font-weight: bold;
        }

        .logo i { font-size: 36px; }

        /* Progress Steps */
        .progress-bar {
            background: white;
            padding: 20px 60px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            background: #e5e7eb;
            color: #999;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: #0891b2;
            color: white;
        }

        .step.done .step-circle {
            background: #10b981;
            color: white;
        }

        .step-label {
            font-size: 14px;
            color: #999;
            font-weight: 500;
        }

        .step.active .step-label { color: #0891b2; font-weight: 600; }
        .step.done .step-label { color: #10b981; }

        .step-line {
            width: 80px;
            height: 2px;
            background: #e5e7eb;
            margin: 0 10px;
        }

        .step-line.done { background: #10b981; }

        /* Container */
        .container {
            max-width: 1300px;
            margin: 40px auto;
            padding: 0 60px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
        }

        /* Form Section */
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .card h3 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .card h3 i { color: #0891b2; }

        /* Form Fields */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.full { grid-template-columns: 1fr; }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group label span {
            color: #ef4444;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0891b2;
        }

        /* Delivery Options */
        .delivery-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .delivery-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .delivery-option:hover { border-color: #0891b2; }

        .delivery-option.selected {
            border-color: #0891b2;
            background: #f0f9ff;
        }

        .delivery-option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: #0891b2;
        }

        .delivery-icon {
            font-size: 28px;
            color: #0891b2;
            width: 40px;
            text-align: center;
        }

        .delivery-info { flex: 1; }

        .delivery-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .delivery-desc { font-size: 13px; color: #666; }

        .delivery-price {
            font-size: 1.3em;
            font-weight: bold;
            color: #0891b2;
        }

        /* Payment Options */
        .payment-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .payment-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .payment-option:hover { border-color: #0891b2; }

        .payment-option.selected {
            border-color: #0891b2;
            background: #f0f9ff;
        }

        .payment-option input[type="radio"] { display: none; }

        .payment-option i {
            font-size: 32px;
            color: #0891b2;
            margin-bottom: 10px;
        }

        .payment-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .payment-desc { font-size: 12px; color: #666; }

        /* Card Payment Fields */
        #cardFields {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Order Summary */
        .summary-section {
            position: sticky;
            top: 20px;
            height: fit-content;
        }

        .summary-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .summary-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .summary-item:last-child { border-bottom: none; }

        .summary-item-img {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .summary-item-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .summary-item-info { flex: 1; }

        .summary-item-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .summary-item-detail {
            font-size: 12px;
            color: #666;
        }

        .summary-item-price {
            font-weight: bold;
            color: #0891b2;
            font-size: 15px;
        }

        .service-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 5px;
        }

        .service-tag {
            background: #f0f9ff;
            color: #0891b2;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
        }

        /* Price Breakdown */
        .price-breakdown {
            border-top: 2px solid #e5e7eb;
            padding-top: 20px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .price-row .label { color: #666; }
        .price-row .value { font-weight: 600; }

        .price-row.total {
            font-size: 1.4em;
            font-weight: bold;
            color: #0891b2;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e5e7eb;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .back-to-cart {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #0891b2;
            text-decoration: none;
            font-size: 14px;
        }

        .back-to-cart:hover { text-decoration: underline; }

        /* Success Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 50px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-icon {
            font-size: 80px;
            color: #10b981;
            margin-bottom: 20px;
        }

        .modal h2 {
            color: #333;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .modal p {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .order-number {
            background: #f0f9ff;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.5em;
            font-weight: bold;
            color: #0891b2;
            margin-bottom: 30px;
        }

        .modal-btn {
            background: linear-gradient(135deg, #0891b2, #06b6d4);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(8, 145, 178, 0.4);
        }

        /* Empty cart */
        .empty-cart {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px;
            background: white;
            border-radius: 15px;
        }

        .empty-cart i {
            font-size: 80px;
            color: #ddd;
            margin-bottom: 20px;
        }

        /* Responsive */
        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .top-bar, .progress-bar { padding: 15px 20px; }

            .payment-options { grid-template-columns: 1fr; }

            .form-row { grid-template-columns: 1fr; }

            .summary-section { position: static; }
        }
    </style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="top-bar">
        <a href="index.html" class="logo">
            <i class="fas fa-wind"></i>
            <span>Климатици ЕООД</span>
        </a>
        <div style="color: #666; font-size: 14px;">
            <i class="fas fa-lock" style="color: #10b981;"></i>
            Сигурно плащане
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="progress-bar">
        <div class="step done">
            <div class="step-circle"><i class="fas fa-check"></i></div>
            <span class="step-label">Количка</span>
        </div>
        <div class="step-line done"></div>
        <div class="step active">
            <div class="step-circle">2</div>
            <span class="step-label">Доставка & Плащане</span>
        </div>
        <div class="step-line"></div>
        <div class="step">
            <div class="step-circle">3</div>
            <span class="step-label">Потвърждение</span>
        </div>
    </div>
</div>

<!-- Main Container -->
<div class="container" id="mainContainer">

    <!-- LEFT: Forms -->
    <div class="form-section">

        <!-- 1. Адрес на доставка -->
        <div class="card">
            <h3><i class="fas fa-map-marker-alt"></i> Адрес на доставка</h3>

            <div class="form-row">
                <div class="form-group">
                    <label>Пълно име <span>*</span></label>
                    <input type="text" id="fullName" placeholder="Иван Петров">
                </div>
                <div class="form-group">
                    <label>Телефон <span>*</span></label>
                    <input type="tel" id="phone" placeholder="0888 123 456">
                </div>
            </div>

            <div class="form-row full">
                <div class="form-group">
                    <label>Адрес <span>*</span></label>
                    <input type="text" id="address" placeholder="ул. Александър Стамболийски 20, ет. 3">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Град <span>*</span></label>
                    <select id="city">
                        <option value="">-- Избери град --</option>
                        <option value="София">София</option>
                        <option value="Пловдив">Пловдив</option>
                        <option value="Варна">Варна</option>
                        <option value="Бургас">Бургас</option>
                        <option value="Стара Загора">Стара Загора</option>
                        <option value="Русе">Русе</option>
                        <option value="Плевен">Плевен</option>
                        <option value="Велико Търново">Велико Търново</option>
                        <option value="Друг">Друг</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Пощенски код</label>
                    <input type="text" id="postalCode" placeholder="1000">
                </div>
            </div>

            <div class="form-row full">
                <div class="form-group">
                    <label>Допълнителни инструкции</label>
                    <textarea id="notes" rows="2" placeholder="Забележки към поръчката..."></textarea>
                </div>
            </div>
        </div>

        <!-- 2. Начин на доставка -->
        <div class="card">
            <h3><i class="fas fa-truck"></i> Начин на доставка</h3>

            <div class="delivery-options" id="deliveryOptions">
                <!-- Loaded from API -->
            </div>
        </div>

        <!-- 3. Начин на плащане -->
        <div class="card">
            <h3><i class="fas fa-credit-card"></i> Начин на плащане</h3>

            <div class="payment-options">
                <label class="payment-option selected" onclick="selectPayment('cash', this)">
                    <input type="radio" name="payment" value="cash" checked>
                    <i class="fas fa-money-bill-wave"></i>
                    <div class="payment-name">Наложен платеж</div>
                    <div class="payment-desc">Плащате при доставка</div>
                </label>

                <label class="payment-option" onclick="selectPayment('bank', this)">
                    <input type="radio" name="payment" value="bank">
                    <i class="fas fa-university"></i>
                    <div class="payment-name">Банков превод</div>
                    <div class="payment-desc">IBAN: BG12 AAAA 1234</div>
                </label>

                <label class="payment-option" onclick="selectPayment('card', this)">
                    <input type="radio" name="payment" value="card">
                    <i class="fas fa-credit-card"></i>
                    <div class="payment-name">Онлайн с карта</div>
                    <div class="payment-desc">Visa / Mastercard</div>
                </label>
            </div>

            <!-- Полета за карта (показват се само при card) -->
            <div id="cardFields">
                <div class="form-row">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Номер на карта</label>
                        <input type="text" placeholder="1234 5678 9012 3456" maxlength="19"
                               oninput="formatCardNumber(this)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Валидност</label>
                        <input type="text" placeholder="MM/YY" maxlength="5">
                    </div>
                    <div class="form-group">
                        <label>CVV</label>
                        <input type="text" placeholder="123" maxlength="3">
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>Име на картата</label>
                        <input type="text" placeholder="IVAN PETROV">
                    </div>
                </div>
                <p style="color: #10b981; font-size: 13px; margin-top: 10px;">
                    <i class="fas fa-shield-alt"></i>
                    Тестова среда - не въвеждай реални данни
                </p>
            </div>
        </div>

    </div>

    <!-- RIGHT: Order Summary -->
    <div class="summary-section">
        <div class="card">
            <h3><i class="fas fa-shopping-bag"></i> Твоята поръчка</h3>

            <div class="summary-items" id="summaryItems">
                <!-- Loaded from cart -->
            </div>

            <div class="price-breakdown">
                <div class="price-row">
                    <span class="label">Продукти:</span>
                    <span class="value" id="productsTotal">0.00 лв</span>
                </div>
                <div class="price-row">
                    <span class="label">Услуги:</span>
                    <span class="value" id="servicesTotal">0.00 лв</span>
                </div>
                <div class="price-row">
                    <span class="label">Доставка:</span>
                    <span class="value" id="deliveryTotal">0.00 лв</span>
                </div>
                <div class="price-row total">
                    <span>Обща сума:</span>
                    <span id="grandTotal">0.00 лв</span>
                </div>
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitOrder()">
                <i class="fas fa-check-circle"></i>
                Потвърди поръчката
            </button>

            <a href="cart.html" class="back-to-cart">
                <i class="fas fa-arrow-left"></i> Обратно към количката
            </a>
        </div>
    </div>

</div>

<!-- Success Modal -->
<div class="modal-overlay" id="successModal">
    <div class="modal">
        <div class="modal-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h2>Поръчката е направена!</h2>
        <p>Благодарим Ви! Ще се свържем с Вас скоро за потвърждение.</p>
        <div class="order-number" id="orderNumber">
            #0000
        </div>
        <button class="modal-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-home"></i> Към началото
        </button>
    </div>
</div>

<!-- Cart Manager -->
<script src="assets/js/cart-manager.js"></script>

<script>
    const API_URL = 'http://localhost/Diplomna/api';
    let selectedDelivery = null;
    let deliveryServices = [];

    window.addEventListener('DOMContentLoaded', () => {
        const cart = CartManager.getCart();

        // Ако количката е празна → обратно към количката
        if (cart.length === 0) {
            alert('Количката е празна!');
            window.location.href = 'cart.html';
            return;
        }

        loadDeliveryOptions();
        renderSummary(cart);
    });

    // Зареди опциите за доставка от API
    async function loadDeliveryOptions() {
        try {
            const response = await fetch(`${API_URL}/services/get_all.php`);
            const result = await response.json();

            if (result.success) {
                deliveryServices = result.services.filter(s => s.service_type === 'delivery');
                renderDeliveryOptions(deliveryServices);
            }
        } catch (error) {
            console.error('Error loading delivery options:', error);
            // Default опции ако API не работи
            deliveryServices = [
                { service_id: 1, service_name: 'Стандартна доставка', description: '3-5 работни дни', price: 30, service_type: 'delivery' },
                { service_id: 2, service_name: 'Експресна доставка', description: 'Доставка в рамките на 24 часа', price: 60, service_type: 'delivery' }
            ];
            renderDeliveryOptions(deliveryServices);
        }
    }

    // Рендерирай опциите за доставка
    function renderDeliveryOptions(services) {
        const container = document.getElementById('deliveryOptions');

        const icons = {
            'Стандартна доставка': 'fa-truck',
            'Експресна доставка': 'fa-bolt',
        };

        container.innerHTML = services.map((service, index) => `
            <div class="delivery-option ${index === 0 ? 'selected' : ''}"
                 id="delivery_div_${service.service_id}"
                 onclick="selectDelivery(${service.service_id}, ${service.price}, this)">
                <input type="radio" name="delivery" 
                       id="delivery_${service.service_id}"
                       value="${service.service_id}"
                       ${index === 0 ? 'checked' : ''}>
                <div class="delivery-icon">
                    <i class="fas ${icons[service.service_name] || 'fa-truck'}"></i>
                </div>
                <div class="delivery-info">
                    <div class="delivery-name">${service.service_name}</div>
                    <div class="delivery-desc">${service.description || ''}</div>
                </div>
                <div class="delivery-price">${parseFloat(service.price).toFixed(2)} лв</div>
            </div>
        `).join('');

        // Избери първата опция по подразбиране
        if (services.length > 0) {
            selectDelivery(services[0].service_id, services[0].price, document.getElementById(`delivery_div_${services[0].service_id}`));
        }
    }

    // Избор на доставка
    function selectDelivery(serviceId, price, element) {
        selectedDelivery = { service_id: serviceId, price: parseFloat(price) };

        // Update UI - премахни selected от всички
        document.querySelectorAll('.delivery-option').forEach(el => {
            el.classList.remove('selected');
        });

        // Добави selected към избрания
        if (element) {
            element.classList.add('selected');
        } else {
            const div = document.getElementById(`delivery_div_${serviceId}`);
            if (div) div.classList.add('selected');
        }

        // Обнови radio бутона
        const radio = document.getElementById(`delivery_${serviceId}`);
        if (radio) radio.checked = true;

        updateTotals();
    }

    // Избор на плащане
    function selectPayment(method, element) {
        document.querySelectorAll('.payment-option').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');

        // Показваме/скриваме полетата за карта
        const cardFields = document.getElementById('cardFields');
        cardFields.style.display = method === 'card' ? 'block' : 'none';
    }

    // Рендерирай обобщение на поръчката
    function renderSummary(cart) {
        const container = document.getElementById('summaryItems');

        container.innerHTML = cart.map(item => `
            <div class="summary-item">
                <div class="summary-item-img">
                    <img src="${item.product.main_image_url || ''}" alt="${item.product.model_name}"
                         onerror="this.src='https://via.placeholder.com/60?text=AC'">
                </div>
                <div class="summary-item-info">
                    <div class="summary-item-name">${item.product.brand_name} ${item.product.model_name}</div>
                    <div class="summary-item-detail">Количество: ${item.quantity}</div>
                    ${item.services && item.services.length > 0 ? `
                        <div class="service-tags">
                            ${item.services.map(s => `
                                <span class="service-tag">
                                    <i class="fas fa-tools"></i> ${s.service_name}
                                </span>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                <div class="summary-item-price">${item.totalPrice.toFixed(2)} лв</div>
            </div>
        `).join('');

        updateTotals();
    }

    // Обнови общите суми
    function updateTotals() {
        const cart = CartManager.getCart();

        let productsTotal = 0;
        let servicesTotal = 0;

        cart.forEach(item => {
            productsTotal += item.unitPrice * item.quantity;
            servicesTotal += item.servicesPrice || 0;
        });

        const deliveryPrice = selectedDelivery ? selectedDelivery.price : 0;
        const grandTotal = productsTotal + servicesTotal + deliveryPrice;

        document.getElementById('productsTotal').textContent = productsTotal.toFixed(2) + ' лв';
        document.getElementById('servicesTotal').textContent = servicesTotal.toFixed(2) + ' лв';
        document.getElementById('deliveryTotal').textContent = deliveryPrice.toFixed(2) + ' лв';
        document.getElementById('grandTotal').textContent = grandTotal.toFixed(2) + ' лв';
    }

    // Форматиране на номер на карта
    function formatCardNumber(input) {
        let value = input.value.replace(/\D/g, '');
        value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
        input.value = value;
    }

    // Подаване на поръчката
    async function submitOrder() {
        // Валидация
        const fullName = document.getElementById('fullName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const city = document.getElementById('city').value;

        if (!fullName || !phone || !address || !city) {
            alert('Моля попълнете всички задължителни полета!');
            return;
        }

        if (!selectedDelivery) {
            alert('Моля изберете начин на доставка!');
            return;
        }

        const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
        const cart = CartManager.getCart();

        // Изчисли обща сума
        let total = 0;
        cart.forEach(item => {
            total += item.totalPrice;
        });
        total += selectedDelivery.price;

        // Подготви данни
        const orderData = {
            full_name: fullName,
            phone: phone,
            delivery_address: address,
            city: city,
            postal_code: document.getElementById('postalCode').value.trim(),
            notes: document.getElementById('notes').value.trim(),
            payment_method: paymentMethod,
            delivery_service_id: selectedDelivery.service_id,
            total_amount: total,
            items: cart
        };

        // Вземи user_id от localStorage (ако е логнат)
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        if (user) orderData.user_id = user.user_id;

        // Disable бутона
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обработване...';

        try {
            const response = await fetch(`${API_URL}/orders/create.php`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });

            const result = await response.json();

            if (result.success) {
                // Изчисти количката
                CartManager.clearCart();

                // Покажи успех modal
                document.getElementById('orderNumber').textContent = `#${String(result.order_id).padStart(4, '0')}`;
                document.getElementById('successModal').classList.add('active');

                // Update progress bar
                document.querySelectorAll('.step')[1].classList.add('done');
                document.querySelectorAll('.step-line')[1].classList.add('done');
                document.querySelectorAll('.step')[2].classList.add('active');

            } else {
                alert('Грешка: ' + result.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Потвърди поръчката';
            }

        } catch (error) {
            console.error('Error:', error);
            alert('Грешка при свързване със сървъра');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check-circle"></i> Потвърди поръчката';
        }
    }
</script>

</body>
</html>